<!doctype html><html lang=zh-cn><meta charset=utf-8><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><meta name=keywords content="代码审计,PHP"><meta name=description content="2018年9月1日，阿里云态势感知发布预警，近日利用ECShop全系列版本的远程代码执行漏洞进行批量化攻击量呈上升趋势，该漏洞可直接导致网站服务器沦陷，黑客可通过WEB攻击直接获得服务器权限，利用简单且危害较大。因此，阿里云安全专家提醒ECShop系统用户及时进行修复。"><title>ECShop全系列版本远程代码执行高危漏洞分析&nbsp;&ndash;&nbsp;WTFSec</title><link rel=stylesheet href=/css/core.min.58bc4672a8045a0810ba4ad30a08c6d5589db1109ca0aa2e07c5e5438201ea8d11642ffa31d8ee7665d6a1b66ab9a3c5.css integrity=sha384-WLxGcqgEWggQukrTCgjG1VidsRCcoKouB8XlQ4IB6o0RZC/6MdjudmXWobZquaPF><meta name=twitter:card content="summary"><meta name=twitter:title content="ECShop全系列版本远程代码执行高危漏洞分析"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">WTFSec</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories/>分类</a><a class="nav item" href=/tags/>标签</a><a class="nav item" href=/link/>友链</a>
<input placeholder="Google 站内搜索" id=search_input style=width:150px>
<button onclick=search()><svg width="13" height="13" viewBox="0 0 13 13"><title>搜尋</title><path d="m4.8495 7.8226c.82666.0 1.5262-.29146 2.0985-.87438.57232-.58292.86378-1.2877.87438-2.1144.010599-.82666-.28086-1.5262-.87438-2.0985-.59352-.57232-1.293-.86378-2.0985-.87438-.8055-.010599-1.5103.28086-2.1144.87438-.60414.59352-.8956 1.293-.87438 2.0985.021197.8055.31266 1.5103.87438 2.1144.56172.60414 1.2665.8956 2.1144.87438zm4.4695.2115 3.681 3.6819-1.259 1.284-3.6817-3.7.0019784-.69479-.090043-.098846c-.87973.76087-1.92 1.1413-3.1207 1.1413-1.3553.0-2.5025-.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239.4696-2.4966 1.4088-3.4239c.9392-.92727 2.0864-1.3969 3.4417-1.4088 1.3553-.011889 2.4906.45771 3.406 1.4088.9154.95107 1.379 2.0924 1.3909 3.4239.0 1.2126-.38043 2.2588-1.1413 3.1385l.098834.090049z"/></svg></button></nav></div><script>function search(){const search_value=document.getElementById("search_input").value;if(search_value!==''){window.open("/search/?q="+search_value,"_blank");}}
document.getElementById("search_input").addEventListener("keydown",function(e){if(e.key==="Enter"){search()}});</script></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">ECShop全系列版本远程代码执行高危漏洞分析</h1><p class="article date"><span class=lang><a>Hzllaga</a> </span>Monday, September 3, 2018</p></section><article class="article markdown-body"><h2 id=预警>预警</h2><p>2018年9月1日，阿里云态势感知发布预警，近日利用ECShop全系列版本的远程代码执行漏洞进行批量化攻击量呈上升趋势，该漏洞可直接导致网站服务器沦陷，黑客可通过WEB攻击直接获得服务器权限，利用简单且危害较大。因此，阿里云安全专家提醒ECShop系统用户及时进行修复。</p><p>早在1个月前阿里云态势感知就捕获到利用ECShop远程代码执行漏洞进行攻击的真实案例，由于当时该漏洞被利用进行攻击的量不大，阿里云安全团队在做好防御此类漏洞大规模利用攻击的同时，也持续监控该漏洞的利用趋势。</p><p>本文对此漏洞的原理，漏洞攻击利用实例以及影响做了全面分析。在官方补丁没放出之前,建议受影响用户可参考文中的修复建议，及时进行修复。使用阿里云WAF的客户无需升级补丁即可防御该漏洞。</p><h2 id=漏洞原理>漏洞原理</h2><p>该漏洞产生的根本原因在于ECShop系统的user.php文件中，display函数的模板变量可控，导致注入，配合注入可达到远程代码执行的效果。使得攻击者无需登录等操作，直接可以获得服务器的权限。</p><p>首先从user.php文件入手，代码中可以看到，系统读取HTTP_REFERER传递过来的</p><p>内容赋值给$back_act变量。</p><p><img src=https://cdn.wtfsec.org/img/20200223183843.png alt></p><p>接着以$back_act的值为参数，调用assign方法。</p><p><img src=https://cdn.wtfsec.org/img/20200223183859.png alt>
(/user.php)</p><p>assign方法的作用是把可控变量传递给模版函数，紧接着再通过display方法展示到页面上。接下来跟进display内部的insert_mod方法。</p><p><img src=https://cdn.wtfsec.org/img/20200223183911.png alt>
(/includes/cls_template/php)</p><p>insert_mod方法返回了一个动态函数调用，该函数名和参数均可控，根据攻击者</p><p>的利用方法，我们可以得知调用的函数名为insert_ads，接下来跟进这一方法。</p><p><img src=https://cdn.wtfsec.org/img/20200223183928.png alt>
(/includes/lib_insert.php)</p><p>不难发现，$arr[‘id’]和$arr[‘num’]这两个变量，都是外部可控的输入点，在构造攻击向量的过程中执行的SQL语句如下。
<img src=https://cdn.wtfsec.org/img/20200223183945.png alt>
(打印$sql变量)</p><p><img src=https://cdn.wtfsec.org/img/20200223184003.png alt>
(sql语句执行结果)</p><p>接着，程序调用了fetch方法，参数由$row[‘position_style’]变量赋值，这一变量同样为外部可控输入点。</p><p><img src=https://cdn.wtfsec.org/img/20200223184017.png alt>
（/includes/lib_insert.php）</p><p>这里fetch函数调用了危险函数，这就是最终触发漏洞的点。但是参数在传递之前要经过fetch_str方法的处理。</p><p><img src=https://cdn.wtfsec.org/img/20200223184028.png alt>
(/includes/cls_template.php)</p><p>最终输入点依次经过fetch_str、select、get_val，最终传入make_var方法。</p><p><img src=https://cdn.wtfsec.org/img/20200223184047.png alt>
(/includes/cls_template.php）</p><p>最终传递到eval的字符串为:</p><p><img src=https://cdn.wtfsec.org/img/20200223184059.png alt></p><h2 id=漏洞攻击实例>漏洞攻击实例</h2><p>阿里云态势感知于2018年8月1日监控到云上首例此漏洞利用。黑客通过HTTP 请求头的Referer字段植入恶意代码如下：</p><p><img src=https://cdn.wtfsec.org/img/20200223184124.png alt></p><p>当黑客恶意代码成功被执行后，会尝试访问链接：’http://uee.me/MrJc‘
具体的payload代码如下所示：</p><p><img src=https://cdn.wtfsec.org/img/20200223184143.png alt></p><p>其中http://uee.me/MrJc 是一个短连接，其完整的url为： <a href=http://www.thaihaogo.com/images/201608/4.jpg>http://www.thaihaogo.com/images/201608/4.jpg</a>。</p><p>此文件下载到成功后会重命名为1.php，实际上4.jpg文件就是一个混淆后的php木马。</p><p><img src=https://cdn.wtfsec.org/img/20200223184216.png alt></p><p>去除混淆部分，将木马执行逻辑还原如下：</p><p><img src=https://cdn.wtfsec.org/img/20200223184233.png alt></p><p>该木马中的PHP代码会去下载一个功能齐全的WEB木马，地址为：http://i.niupic.com/images/2017/05/26/Lfkavl.gif
该WEB木马的功能详情如下：</p><p><img src=https://cdn.wtfsec.org/img/20200223184248.png alt></p><h2 id=漏洞影响>漏洞影响</h2><p>阿里云应急中心测试发现，ECShop全系列版本（包括2.x、3.0.x、3.6.x）均存在该远程代码执行漏洞。阿里云态势感知数据研究中心监控的数据显示，该漏洞利用难度低，影响面广，并已经发现有批量入侵迹象，需要存在相关业务的用户及时关注并进行修补。</p><h2 id=专家建议>专家建议</h2><p>在官方补丁没放出之前，我们建议站长可以修改include/lib_insert.php文件中相关漏洞的代码，将$arr[id]和$arr[num]强制将数据转换成整型，该方法可作为临时修复方案将入侵风险降到最低。需要修改的部分代码如下：</p><p><img src=https://cdn.wtfsec.org/img/20200223184331.png alt>
(includes/lib_insert.php )</p><p>另外，使用阿里云WAF 的客户无需升级补丁即可防御该漏洞。</p></article><section class="article labels"><a class=category href=/categories/%E8%BD%AC%E8%BD%BD/>转载</a><a class=tag href=/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/>代码审计</a><a class=tag href=/tags/php/>PHP</a></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/wordpress%E7%96%91%E4%BC%BC%E5%AD%98%E5%9C%A8%E5%90%8E%E9%97%A8-%E5%A4%9A%E4%B8%AA%E7%BD%91%E7%AB%99%E5%8F%AF%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/><span class=li>&larr;</span>WordPress疑似存在后门 多个网站可直接读取任意文件</a></p><p><a class=link href=/posts/c-sharp-.netthread-%E5%9F%B7%E8%A1%8C%E7%B7%92%E9%9B%86%E5%8D%80-threadpool/><span class=li>&rarr;</span>[C#.NET][Thread] 執行緒集區 – ThreadPool</a></p></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>©2014-2020 WTFSec.</p><p class=powerby><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/ target=_blank>Notepadium</a></p><p class=powerby><span>CDN by </span><a href=https://cf.wtfsec.org target=_blank>Cloudflare</a><span> and </span><a href="https://console.upyun.com/register/?invite=H1xhvqTVV" target=_blank>又拍云</a></p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-83215806-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script data-ad-client=ca-pub-4220670081232153 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></body></html>